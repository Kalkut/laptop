sand.define("touch/Gesture",["Seed"],function(a){return a.Seed.extend({"+init":function(a){this.touches=[],this.noRightClick=a.noRightClick;for(var b=-1,c=a.touches.length;++b<c;)this.touches.push({clientX:a.touches[b].clientX||a.touches[b].pageX,clientY:a.touches[b].clientY||a.touches[b].pageY,identifier:a.touches[b].identifier});this.center=this.getCenter(),this.touches.length>1?(this.dist=this.getDist(this.center),this.v=this.getV()):(this._sc=this.center,this.noRightClick||(this._timeout=setTimeout(function(){this.fire("longtap",[a.e]),drag=null,this._timeout=null,this.fire("destroy")}.bind(this),500)))},getV:function(){var a=[];for(var b=-1,c=this.touches.length;++b<c;)a.push(this.center.minus([this.touches[b].clientX,this.touches[b].clientY]));return a},getCenter:function(){var a=[0,0];for(var b=this.touches.length;b--;){var c=this.touches[b];a=a.add([c.clientX,c.clientY])}return a.divide(this.touches.length)},getDist:function(a){var b=0;for(var c=this.touches.length;c--;){var d=this.touches[c];b+=Math.sqrt(Math.pow(a[0]-d.clientX,2)+Math.pow(a[1]-d.clientY,2))}return b/this.touches.length},touchstart:function(a){for(var b=-1,c=a.length;++b<c;)this.touches.where("identifier",a[b].identifier)||this.touches.push({clientX:a[b].clientX||a[b].pageX,clientY:a[b].clientY||a[b].pageY,identifier:a[b].identifier});this._timeout&&this.touches.length>1&&(clearTimeout(this._timeout),this._timeout=!1),this.v=this.getV(),this.center=this.getCenter(),this.dist=this.getDist(this.center)},touchmove:function(a,b){for(var c=-1,d=a.length;++c<d;){var e=this.touches.where("identifier",a[c].identifier);e.set("clientX",a[c].clientX||a[c].pageX),e.set("clientY",a[c].clientY||a[c].pageY)}var f=this.getCenter();this.touches.length===1&&this._timeout?f.minus(this._sc).dist()>40&&(clearTimeout(this._timeout),this._timeout=null,this.refresh(b)):this.refresh(b)},preventRightClick:function(){return},touchend:function(a){for(var b=a.length;b--;){var c=a[b];for(var d=this.touches.length;d--;)this.touches[d].identifier===c.identifier&&this.touches.splice(d,1)}if(!this.touches.length){this._timeout&&(clearTimeout(this._timeout),this._timeout=null,this.fire("tap")),this.fire("destroy");return}this.center=this.getCenter(),this.dist=this.getDist(this.center)},refresh:function(a){var b=this.getCenter();b.equals(this.center)||(this.fire("translate",b.minus(this.center),a),this.center=b);if(this.touches.length>1){var c=this.getDist(b);c!==this.dist&&(this.fire("scale",c/this.dist,a),this.dist=c);var d=this.getV();if(this.v){var e=0;d.each(function(a,b){e+=(a[1]/a[0]>this.v[b][1]/this.v[b][0]?1:-1)*Math.acos((this.v[b][0]*a[0]+this.v[b][1]*a[1])/(Math.sqrt(Math.pow(this.v[b][0],2)+Math.pow(this.v[b][1],2))*Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2))))}.bind(this)),e/=this.touches.length,isNaN(e)&&(e=0),this.fire("rotate",e)}this.v=d}else this.v=null}})}),sand.define("DOM/UA",["core/Array/where"],function(){var a;if(typeof navigator=="undefined"){this.exports="firefox";return}var b=navigator.userAgent.toLowerCase();b.indexOf("ipad")!==-1?a="ipad":b.indexOf("chrome")!==-1||b.indexOf("safari")!==-1?a="chrome":b.indexOf("firefox")!==-1?a="firefox":b.indexOf("opera")!==-1?a="opera":a="ie",Array.prototype.slice.call(navigator.plugins).map(function(a){return a.name}).where(function(a){return a.match(/npTuioClient/)}).length>0&&(a="ipad"),typeof __UA!="undefined"&&(console.log("FORCING UA"),a=__UA),window.location.href.search("touch")!==-1&&(a="ipad");var c="ontouchstart"in document.documentElement;return c&&(a="ipad"),window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),a}),sand.define("DOM/caretAtEnd",[],function(){return function(a){a.focus();if(typeof window.getSelection!="undefined"&&typeof document.createRange!="undefined"){var b=document.createRange();b.selectNodeContents(a),b.collapse(!1);var c=window.getSelection();c.removeAllRanges(),c.addRange(b)}else if(typeof document.body.createTextRange!="undefined"){var d=document.body.createTextRange();d.moveToElementText(a),d.collapse(!1),d.select()}}}),sand.define("DOM/createClass",function(){return function(a,b){var c=document.createElement("style"),d="";d+=a+"{";for(var e in b)d+=e+":"+b[e]+";";c.innerHTML=d+"}",document.head.appendChild(c)}}),sand.define("DOM/ctrlaable",["DOM/handle"],function(a){var b=a.handle;this.exports=function(a){var c=b(a);c.keydown(function(b){b.keyIdentifier&&b.keyIdentifier==="Meta"&&(this._cmd=!0),this._cmd&&b.keyCode===65&&a.select()}.bind(this)),c.keyup(function(a){a.keyIdentifier&&a.keyIdentifier==="Meta"&&(this._cmd=!1)}.bind(this))}}),sand.define("DOM/devices/Chrome",["DOM/devices/Firefox"],function(a){var b=a.Firefox.extend({attachScroll:function(){this.node.addEventListener("mousewheel",function(a){a=this.wrap(a),a.scale=a.wheelDelta<0?2:.5,this.fire("scroll",[a])}.bind(this))}});return b}),sand.define("DOM/devices/Firefox",["Seed"],function(a){var b=null,c=null,d,e=0,f=0,g=a.Seed.extend({cancelDrag:function(){this.detach("mouseup"),this.detach("mousemove"),$(document).unbind("mousemove",d),document.onmouseup=null,b=null},detachAll:function(){for(var a in this.attached)this.detach(a)},init:function(a){this.id=++e;var b=a.svg,c=a.node;this.node=c,this.attached={},b?(this.attach=function(a,b){c.each?c.each(function(c){c.attach?c.attach(a,b):c[a](b)}):c.attach?c.attach(a,b):c[a](b),this[a]=b}.bind(this),this.detach=function(a){c.each?c.each(function(b){b.detach?b.detach(a):b["un"+a](this[a])}.bind(this)):c.detach?c.detach(a):c["un"+a](this[a])},this.svg=!0):(this.attach=function(a,b){this.attached[a]=!0,c.each?c.each(function(c){c["on"+a]=b}):c["on"+a]=b,this.attached[a]=!0}.bind(this),this.detach=function(a){c.each?c.each(function(b){b["on"+a]=null}):c["on"+a]=null,this.attached[a]=!1}),this.preventSelect=!!a.preventSelect,this.$listeners={},this.$observers=[]},changeDraged:function(a,b){this.undrag(a),b.draged(a)},wrapKey:function(a){return a=this.wrap(a),a.shift=a.keyCode===16,a.enter=a.keyCode===13,a.escape=a.keyCode===27,a.backspace=a.keyCode===8,a},wrap:function(a){return a.halt=function(){a.stopPropagation(),a.preventDefault()}.bind(this),a.xy=[a.clientX,a.clientY],a.rightClick=a.which&&a.which===3||a.button&&a.button==2,a},scroll:{name:"DOMMouseScroll"},scrollWrap:function(a,b){var c=this;return function(d){a.call(b,{scale:d.deltaY>0?2:.5,xy:[d.clientX,d.clientY],e:c.wrap(d)})}},attachScroll:function(){this.node.addEventListener("wheel",function(a){a=this.wrap(a),a.scale=a.deltaY>0?2:.5,this.fire("scroll",[a])}.bind(this),!0)},undrag:function(a,e){++f,a=this.wrap(a),this.right||this.fire("drag:end",[a]),!this.moved&&!this.right&&this.fire("click",[a]),this.detach("mousemove"),this.detach("mouseup"),$(document).unbind("mousemove",d),document.onmouseup=null,b=!1,c=!1;if(this.right)return;e&&e.end&&e.end(a)},draged:function(a,b){b||(b={}),b.force=!0,this._drag(a,b),this.moved=!0},_drag:function(a,c){if(b)return;this.preventSelect&&a.preventDefault(),b=this.node,a=this.wrap(a),this.moved=!1;var e=function(a){if(this.right)return;a=this.wrap(a),this.moved=!0,this.fire("drag:drag",[a]),a.halt()}.bind(this);d=e,$(document).bind("mousemove",d),this.attach("mousemove",e),document.onmouseup=function(a){this.undrag(a,c)}.bind(this),this.attach("mouseup",function(a){document.onmouseup(a)}.bind(this)),a.which===3||a.rightClick?(this.right=!0,this.fire("rightclick",[a])):(this.right=!1,this.fire("drag:start",[a,c]))},isDescendantOf:function(a){var b=this.node;while(b!==null){if(b==a)return!0;b=b.parentNode}},isAncestorOf:function(a){var b=function(c){var d=c.childNodes;for(var e=d.length;e--;)if(d[e]===a||b(d[e]))return!0;return!1};return b(this.node)},on:function(b,c,d){var e;return b==="drag:start"||b==="drag:drag"||b==="drag:end"?e="drag":e=b,this["isListeningTo"+e.capitalize()]||(e==="drag"?this.attach("mousedown",this._drag.bind(this)):b==="click"?typeof this.isListeningToDrag=="undefined"&&this.attach("click",function(a){a=this.wrap(a),this.fire("click",[a])}.bind(this)):b==="dblclick"?typeof this.isListeningToDrag=="undefined"?this.attach("click",function(a){a=this.wrap(a);var b=new Date;this._lastClickDate&&b-this._lastClickDate<250?(this._clickTimeout&&clearTimeout(this._clickTimeout),this.fire("dblclick",[a]),this._lastClickDate=null):(this._clickTimeout=setTimeout(function(){this.fire("click",[a])}.bind(this),10),this._lastClickDate=new Date),a.halt()}.bind(this)):this.on("click",function(a){var b=a[0],c=new Date;this._lastClickDate&&c-this._lastClickDate<250&&(this._clickTimeout&&clearTimeout(this._clickTimeout),this.fire("dblclick",[b]),this._lastClickDate=null),this._lastClickDate=new Date}.bind(this)):b==="over"?this.attach("mouseover",function(a){a=this.wrap(a),this.fire("over",[a])}.bind(this)):b==="out"?this.attach("mouseout",function(a){a=this.wrap(a),this.fire("out",[a])}.bind(this)):b==="keyDown"?this.attach("keydown",function(a){a=this.wrapKey(a),this.fire("keyDown",[a])}.bind(this)):b==="keyUp"?this.attach("keyup",function(a){a=this.wrapKey(a),this.fire("keyUp",[a])}.bind(this)):b==="scroll"?this.attachScroll():b==="contextmenu"?this.attach("contextmenu",function(a){a=this.wrap(a),this.fire("contextmenu",[a])}.bind(this)):b==="mousedown"?this.attach("mousedown",function(a){a=this.wrap(a),this.fire("mousedown",[a])}.bind(this)):b==="mouseup"&&this.attach("mouseup",function(a){a=this.wrap(a),this.fire("mouseup",[a])}.bind(this)),this["isListeningTo"+e.capitalize()]=!0),a.Seed.prototype.on.call(this,b,c,this)}});return g}),sand.define("DOM/devices/Ipad",["Seed","core/clone","core/hardClone","core/Function/bind","DOM/devices/Firefox","touch/Gesture"],function(a){Array.prototype.dist=function(){return Math.sqrt(this[0]*this[0]+this[1]*this[1])};var b=40,c=0,d=0,e=!1,f=this.debug&&this.debug.d,g=null,h,i=null,j=null,k=a.Seed.extend({"+init":function(a){this.number=d++,this.moved=!1;var b=a.svg,c=a.node;this.node=c,this.initEvents(b,c),this.resetAttrs()},initEvents:function(a,b){a?(this.attach=function(a,c){b.attach?b.attach(a,c):b.attach(a,c),this[a]=c}.bind(this),this.detach=function(a){b.detach?b[a](function(){}):b["un"+a]&&b["un"+a](this[a])}):(this.attach=function(a,c){b["on"+a]=c},this.detach=function(a){b["on"+a]=null}),this.attach("touchstart",this._touchstart.bind(this)),this.attach("touchmove",this._touchmove.bind(this)),this.attach("touchend",this._touchend.bind(this)),this.attach("touchcancel",this._touchend.bind(this)),a||(this.attach("keydown",function(a){this.fire("keydown",[a])}.bind(this)),this.attach("focus",function(a){this.fire("focus",[a])}.bind(this)))},baseDraggingAttrs:{dragOn:!1,nTouches:0,touches:[],distance:!1,scale:1,start:{center:!1,distance:!1,centerPos:!1},tr:[0,0],center:!1},detachAll:function(){},setAttrsFromTouches:function(a){var b=a.length,c=this.attrs.nTouches;if(b==0){this.resetAttrs();return}var d=a[0]?a[1]?[a[0],a[1]]:[a[0]]:[];if(b==c){this.setAttrsGeo(d);return}this.touchesTransfer(d),this.setAttrsGeo(d);return},resetAttrs:function(){this.attrs=a.hardClone(this.baseDraggingAttrs)},changeDraged:function(a,b){this._undrag(a),f=!0,b.device.manageEvent(a,!0),this.toDrag=b.device},touchesTransfer:function(b){if(b.length>1){var c=this.attrs.distance,d=this.getDistance(b[0].pageX,b[0].pageY,b[1].pageX,b[1].pageY);c?this.attrs.start.distance=this.attrs.start.distance/c*d:this.attrs.start.distance=d;var e=this.getCenter(b[0].pageX,b[0].pageY,b[1].pageX,b[1].pageY)}else var e=[b[0].pageX,b[0].pageY];var f=this.attrs.center;if(f)this.attrs.start.center=this.attrs.start.center.add(e.minus(f).multiply(1/(this.attrs.scale||1)));else{this.attrs.dragOn=!0,this.attrs.start.center=e;var g=a.jQ(this.node),h=g.offset()||[0,0];try{this.attrs.start.centerPos=[g.width()/2+h.left||0,g.height()/2+h.top||0]}catch(i){this.attrs.start.centerPos=[0,0]}}},setAttrsGeo:function(a){a.length==2?this.setDistanceAverageTranslationAndScale(a):this.setTrAndCenter([a[0].pageX,a[0].pageY])},getDistance:function(a,b,c,d){return Math.sqrt((a-c)*(a-c)+(b-d)*(b-d))},getCenter:function(a,b,c,d){return[(a+c)/2,(b+d)/2]},setDistanceAverageTranslationAndScale:function(a){this.attrs.distance=this.getDistance(a[0].pageX,a[0].pageY,a[1].pageX,a[1].pageY),this.setTrAndCenter(this.getCenter(a[0].pageX,a[0].pageY,a[1].pageX,a[1].pageY)),this.attrs.scale=this.attrs.distance/this.attrs.start.distance},setTrAndCenter:function(a){this.attrs.center=a;var b=this.attrs.start;this.attrs.tr=a.minus(b.center).add(b.center.minus(b.centerPos).multiply(1-(this.attrs.scale||1))).multiply(1/this.attrs.scale)},_undrag:function(a){e=!1,h&&h.un(),h=null,this._bounds&&this._bounds["iScroll:end"]?this.fire("iScroll:end",[a]):this.fire("drag:end",[a]),this.resetAttrs();if(!this.moved){this.fire("click",[a]);return}this.moved=!1},_drag:function(a,b){this._touchstart(a)},wrapTouches:function(a){var b=a;return b.touches=a.touches||[],b.x=this.attrs.center[0],b.y=this.attrs.center[1],b.xy=this.attrs.center,b.halt=function(){a.stopPropagation(),a.preventDefault()},b.target=this.node,b.scaling=this.attrs.scale,b.translate=this.attrs.tr,b},manageEvent:function(a,b){var c=a;c.touches=a.touches||[];var d=c.touches.length,e=this.attrs.nTouches;this.setAttrsFromTouches(c.touches||[]),this.attrs.nTouches=d;var f=this.wrapTouches(a);return e==0&&d>0&&this._drag(f,b),e>0&&d==0&&this.onOff(f,b),e==d&&d!==0&&this.onChange(f,b),f},onChange:function(a){this.toDrag._bounds&&this.toDrag._bounds["iScroll:change"]?this.toDrag.fire("iScroll:change",[a]):this.toDrag.fire("drag:drag",[a])},addTouches:function(){},_touchstart:function(b,c){b.halt=b.halt||function(){b.stopPropagation(),b.preventDefault()},this.fire("mousedown",[b,c]);if(["INPUT","TEXTAREA"].include(b.target.tagName)){b.stopPropagation();return}if(j)return;j=this,b.xy=[b.changedTouches[0].clientX||b.changedTouches[0].pageX,b.changedTouches[0].clientY||b.changedTouches[0].pageY],this.gesture=new a.Gesture({touches:b.changedTouches,e:b,noRightClick:this.noRightClick}),this._sc=b.xy,this._cancel=!1;var d=function(a){a.target!==document.getElementById("shift-button")&&(this.gesture.touchstart(a.changedTouches),a.stopPropagation())}.bind(this),e=function(a){this.gesture.touchmove(a.changedTouches,a),a.stopPropagation()}.bind(this),f=function(a){this.gesture.touchend(a.changedTouches),a.stopPropagation()}.bind(this);document.addEventListener("touchstart",d,!0),document.addEventListener("touchmove",e,!0),document.addEventListener("touchend",f,!0),document.addEventListener("touchcancel",f,!0),this.gesture.on("translate",function(a,b){var c={};for(var d in b)c[d]=b[d];c.translation=a,c.xy=[b.touches[0].clientX||b.touches[0].pageX,b.touches[0].clientY||b.touches[0].pageY],c.center=this.gesture.center,this.fire("drag:drag",[c])}.bind(this),this),this.gesture.on("scale",function(a,b){b.scale=a,b.center=this.gesture.center,this.fire("drag:drag",[b])}.bind(this),this),this.gesture.on("longtap",function(){this.fire("rightclick",[b])}.bind(this),this),this.gesture.on("tap",function(){this.fire("click",[b])}.bind(this),this),this.gesture.on("destroy",function(){j=null,document.removeEventListener("touchstart",d,!0),document.removeEventListener("touchmove",e,!0),document.removeEventListener("touchend",f,!0),this.fire("drag:end",[b])}.bind(this),this),this.fire("drag:start",[b,c])},_touchmove:function(a){if(this._cancel||j!==this)return;a.xy=[a.changedTouches[0].clientX,a.changedTouches[0].clientY],a.touches.length<=1,this._timeout?this._sc.minus(a.xy).dist()>b&&(clearTimeout(this._timeout),this._timeout=null,this.fire("drag:drag",[a])):this.fire("drag:drag",[a]),a.preventDefault()},preventRightClick:function(){this.gesture.preventRightClick()},preventRightClick:function(){this.gesture.preventRightClick()},_touchend:function(a){if(this._cancel||j!==this)return;document.ontouchmove=null,document.ontouchend=null,a.xy=[a.changedTouches[0].clientX,a.changedTouches[0].clientY],j=null,this._timeout&&(clearTimeout(this._timeout),this._timeout=null,this.fire("click",[a])),this.fire("drag:end",[a])},wrapKey:function(a){return a=this.wrap(a),a.shift=a.keyCode===16,a.enter=a.keyCode===13,console.log(a.keyCode),a},wrap:function(a){return a.halt=function(){a.stopPropagation(),a.preventDefault()},a.changedTouches&&(a.xy=a.xy||[a.changedTouches[0].clientX,a.changedTouches[0].clientY]),a},cancelDrag:function(a,b){this._timeout&&(clearTimeout(this._timeout),this._timeout=null),j=null,console.log("canceDrag?to:"+b.to),b&&b.to&&b.to.draged(a)},draged:function(a,b){b||(b={}),b.force=!0,j&&(j.cancelDrag(),j=null),this._touchstart(a,b)}});return k}),sand.define("DOM/devices/Opera",function(a,b){return;var c},{requires:"devices.firefox"}),sand.define("DOM/devices/ie",function(a,b){return;var c},{requires:"devices.firefox"}),sand.define("DOM/devices/tuio",function(a,b){return;var c},{requires:["devices"]}),sand.define("DOM/document",["DOM/handle","DOM/state","Seed"],function(a){var b=a.handle,c=b(document);return new(a.Seed.extend({_downs:[],_ups:[],on:function(a,b,d){return c.on(a,b,d)},keyup:function(a){this._ups.push(a)},keydown:function(a){this._downs.push(a)},clear:function(){this._downs=[],this._ups=[]},"+init":function(){this.state=a.state;try{c.keydown(function(b){b.shift?a.state.shifted=!0:b.keyCode===91||b.keyCode===17?a.state.ctrled=!0:b.keyCode===32?a.state.space=!0:b.keyCode===8?b.backspace=!0:b.keyCode>47&&b.keyCode<106?b.char=!0:b.keyCode===37?b.fleche="left":b.keyCode===38?b.fleche="top":b.keyCode===39?b.fleche="right":b.keyCode===40?b.fleche="bottom":b.keyCode===27&&(b.escape=!0),this._downs.each(function(a){a(b)})}.bind(this)),c.keyup(function(b){b.shift?a.state.shifted=!1:a.state.ctrled=!1,b.keyCode===32&&(a.state.space=!1),this._ups.each(function(a){a(b)})}.bind(this))}catch(b){}}}))}),sand.define("DOM/emphasize",function(a){this.exports=function(a,b){}}),sand.define("DOM/fake",function(){var a=document.createElement("div");return a.style.visibility="hidden",a.style.position="absolute",document.body.appendChild(a)}),sand.define("DOM/getImageSize",["DOM/handle","DOM/fake"],function(a){var b=a.fake;this.exports=function(a,c){if(typeof a=="string"){var d=document.createElement("img");d.setAttribute("src",a),b.appendChild(d)}else var d=a,e=!0;d.complete?(c(d.offsetWidth,d.offsetHeight),e||b.removeChild(d)):d.onload=function(){c(d.offsetWidth,d.offsetHeight),e||b.removeChild(d)}}}),sand.define("DOM/getPos",function(a){return function(a,b){var c=[a.offsetLeft,a.offsetTop];if(a.parentNode===b)return c;while((a=a.parentNode)&&typeof a.offsetLeft!="undefined"){c=[c[0]+a.offsetLeft,c[1]+a.offsetTop];if(a.parentNode===b)break}return c}}),sand.define("DOM/getTextSize",function(){return function(a,b,c,d){var e=document.body.appendChild(document.createElement("div"));e.style.visibility="hidden",e.style.zIndex=-1,e.style.fontFamily=c,e.style.cssFloat="left",e.style["float"]="left",e.style.fontSize=typeof b=="number"?b+"px":b,e.innerHTML=a,d(e.offsetWidth),document.body.removeChild(e)}}),sand.define("DOM/handle",["core/extend","DOM/UA","DOM/devices/*","core/String/capitalize"],function(a){var b=a.extend,c=a.UA,d=a.devices[c.capitalize()],e=[];b(Function.prototype,{wrap:function(a){var b=a?this.bind(a):this;return function(a){return b(d.prototype.wrap(a))}},wrapKey:function(a){var b=a?this.bind(a):this;return function(a){return b(d.prototype.wrapKey(a))}}});var f=function(a,c){a.node&&a.node.toString()==="[object HTMLDivElement]"&&(a=a.node),this.node=a,this.device=new d(b(c||{},{node:this.node}))},g=function(a,b){for(var c=e.length;c--;)if(e[c].node===a)return e[c];var d=new f(a,b);return e.push(d),d};return f.prototype={changeDraged:function(a,b){this.device.changeDraged(a,b)},draged:function(a,b){this.device.draged(a,b)},undrag:function(a){this.device.undrag(a)},drag:function(a,b){if(typeof a!="object")return;return a.start&&(this._start&&this._start.un(),this._start=this.device.on("drag:start",function(b){var c=a.start(b[0],b[1]);c&&c.cancel&&(this.device.cancelDrag(b[0],c.cancel),typeof c.cancel=="function"&&c.cancel())}.bind(this),this)),a.drag&&(this._drag&&this._drag.un(),this._drag=this.device.on("drag:drag",function(b){a.drag(b[0])}.bind(this),this)),a.end&&(this._end&&this._end.un(),this._end=this.device.on("drag:end",function(b){a.end(b[0])}.bind(this),this)),a.right&&(this._right=this.device.on("rightclick",function(b){a.right(b[0])},this)),{un:function(){this._start.un(),this._drag.un(),this._end.un(),this._right.un(),this._start=this._drag=this._end=null}.bind(this)}},over:function(a){this._over&&this._over.un(),this._over=this.device.on("over",function(b){a(b[0])}.bind(this))},out:function(a){this._out&&this._out.un(),this._out=this.device.on("out",function(b){a(b[0])}.bind(this))},down:function(a){},up:function(a){},click:function(a){return this.device.on("click",function(b){a(b[0])}.bind(this))},dblclick:function(a){if(c=="ipad"){console.log("[ERROR] you should not try to bind a double-click on the ipad");return}return this.device.$listeners.dblclick=[],this.device.on("dblclick",function(b){a(b[0])}.bind(this))},iScroll:function(a){var b=[this.device.on("iScroll:change",function(b){a.change(b[0]),b[0].halt()}.bind(this)),this.device.on("iScroll:end",function(b){a.end(b[0]),b[0].halt()}.bind(this))];return{un:function(){b[0].un(),b[1].un()}.bind(this)}},scroll:function(a){this.device.$listeners.scroll=[],this.device.on("scroll",function(b){a(b[0])}.bind(this))},keydown:function(a){return this.device.on("keyDown",function(b){a(b[0])}.bind(this))},keyup:function(a){return this.device.on("keyUp",function(b){a(b[0])}.bind(this))},on:function(a,b,c){return this.device.on(a,function(a){b(a[0])}.bind(this),c)}},g}),sand.define("DOM/hexToRgb",function(a){this.exports=function(a){return[(a&16711680)>>16,(a&65280)>>8,a&255]}}),sand.define("DOM/hsvToRgb",function(a){this.exports=function(a,b,c){var b=b/100,c=c/100,d=Math.floor(a/60%6),e=a/60-d,f=c*(1-b),g=c*(1-e*b),h=c*(1-(1-e)*b),i=[];switch(d){case 0:i=[c,h,f];break;case 1:i=[g,c,f];break;case 2:i=[f,c,h];break;case 3:i=[f,g,c];break;case 4:i=[h,f,c];break;case 5:i=[c,f,g]}var j=Math.min(255,Math.round(i[0]*256)),k=Math.min(255,Math.round(i[1]*256)),l=Math.min(255,Math.round(i[2]*256));return[j,k,l]}}),sand.define("DOM/lighten",["DOM/rgbToHsv","DOM/hexToRgb","DOM/rgbToHex","DOM/hsvToRgb"],function(a){var b=a.hexToRgb,c=a.rgbToHex,d=a.rgbToHsv,e=a.hsvToRgb;this.exports=function(a,d){if(a.search("rgb")===-1){a=parseInt("0x"+a.substr(1,a.length-1),16);var e=b(a)}else{var f=/\((.*)\)/.exec(a)[1];e=f.split(",").map(function(a){return parseInt(a.trim())})}var g=function(a){var b=a[0],c=a[1],d=a[2],e=255.999,f=a.max();if(f>e){var g=b+c+d;if(g<3*e){var h=(3*e-g)/(3*f-g),i=e-h*f;return[i+h*b,i+h*c,i+h*d]}return[255,255,255]}return[b,c,d]};return e=g(e.multiply((100+d)/100)),"#"+c(e[0],e[1],e[2])}}),sand.define("DOM/onfontsloaded",function(){var a={};return function(b,c){var d=0,e=function(){d===b.length&&c()},f=function(b,c){function h(){e&&e.offsetWidth!=f&&(++d,a[b]=!0,e.parentNode.removeChild(e),clearInterval(g),c())}var e=document.createElement("span");e.innerHTML="giItT1WQy@!-/#",e.style.position="absolute",e.style.left="-10000px",e.style.top="-10000px",e.style.fontSize="300px",e.style.fontFamily="sans-serif",e.style.fontVariant="normal",e.style.fontStyle="normal",e.style.fontWeight="normal",e.style.letterSpacing="0",document.body.appendChild(e);var f=e.offsetWidth;e.style.fontFamily=b;var g;g=setInterval(h,50)};for(var g=0,h=b.length;g<h;++g)a[b[g]]?d++:f(b[g],e);d===b.length&&c(!0)}}),sand.define("DOM/parents",function(){return function(a,b){while(b){if(b.parentNode===a)return!0;b=b.parentNode}return!1}}),sand.define("DOM/rgbToHex",function(a){this.exports=function(a,b,c){var d=function(a){var b="0123456789ABCDEF";return a==null?"00":(a=parseInt(a),a==0||isNaN(a)?"00":(a=Math.round(Math.min(Math.max(0,a),255)),b.charAt((a-a%16)/16)+b.charAt(a%16)))};return d(a)+d(b)+d(c)}}),sand.define("DOM/rgbToHsv",function(a){this.exports=function(a,b,c){var a=a/255,b=b/255,c=c/255,d=Math.min(Math.min(a,b),c),e=Math.max(Math.max(a,b),c),f=e-d,g=e,h,i;return e==d?i=0:e==a?i=60*((b-c)/(e-d))%360:e==b?i=60*((c-a)/(e-d))+120:e==c&&(i=60*((a-b)/(e-d))+240),i<0&&(i+=360),e==0?h=0:h=1-d/e,[Math.round(i),Math.round(h*100),Math.round(g*100)]}}),sand.define("DOM/select",function(){var a=function(){document.onselectstart=function(a){return a.halt(),!1}.wrap()};return{on:function(){document.onselectstart=null},off:a}}),sand.define("DOM/selection",function(){var a=function(a,b){return b-(a.value.slice(0,b).split("\r\n").length-1)};return{getInputSelection:function(a){var b=0,c=0,d,e,f,g,h;return typeof a.selectionStart=="number"&&typeof a.selectionEnd=="number"?(b=a.selectionStart,c=a.selectionEnd):(e=document.selection.createRange(),e&&e.parentElement()==a&&(g=a.value.length,d=a.value.replace(/\r\n/g,"\n"),f=a.createTextRange(),f.moveToBookmark(e.getBookmark()),h=a.createTextRange(),h.collapse(!1),f.compareEndPoints("StartToEnd",h)>-1?b=c=g:(b=-f.moveStart("character",-g),b+=d.slice(0,b).split("\n").length-1,f.compareEndPoints("EndToEnd",h)>-1?c=g:(c=-f.moveEnd("character",-g),c+=d.slice(0,c).split("\n").length-1)))),{start:b,end:c}},setInputSelection:function(b,c,d){if(typeof b.selectionStart=="number"&&typeof b.selectionEnd=="number")b.selectionStart=c,b.selectionEnd=d;else{var e=b.createTextRange(),f=a(b,c);e.collapse(!0),c==d?e.move("character",f):(e.moveEnd("character",a(b,d)),e.moveStart("character",f)),e.select()}},saveSelection:function(a){function i(a,g){if(a.nodeType==3){!e&&a==g.startContainer&&(c=b+g.startOffset,e=!0);if(e&&a==g.endContainer)throw d=b+g.endOffset,f;b+=a.length}else for(var h=0,j=a.childNodes.length;h<j;++h)i(a.childNodes[h],g)}var b=0,c=0,d=0,e=!1,f={},g=rangy.getSelection(),h;if(g.rangeCount)try{i(a,g.getRangeAt(0))}catch(j){if(j!=f)throw j}return{start:c,end:d}},restoreSelection:function(a,b){function g(a){if(a.nodeType==3){var h=c+a.length;!e&&b.start>=c&&b.start<=h&&(d.setStart(a,b.start-c),e=!0);if(!e||b.end<c||b.end>h)c=h;else throw d.setEnd(a,b.end-c),f}else for(var i=0,j=a.childNodes.length;i<j;++i)g(a.childNodes[i])}var c=0,d=rangy.createRange(),e=!1,f={};d.collapseToPoint(a,0);try{g(a)}catch(h){if(h==f)rangy.getSelection().setSingleRange(d);else throw h}},clear:function(){window.getSelection?window.getSelection().empty?window.getSelection().empty():window.getSelection().removeAllRanges&&window.getSelection().removeAllRanges():document.selection&&document.selection.empty()}}}),sand.define("DOM/state",["DOM/handle"],function(a){return{};var b,c,d}),sand.define("DOM/toDOM",[],function(a,b){var c=function(a,d,e){if(!a)return null;if(a.nodeName)return a;if(typeof a=="string")return c({tag:a},d,e);if(a.length)return c({tag:a[0],children:a[1]},d,e);var f={},g;if(!a.tag)f.tag="div";else{var h=a.tag.split(/ /),i=h.shift();h.length&&(f.innerHTML=h.join(" ")),a.innerHTML&&(f.innerHTML=a.innerHTML),h=i.split(/\.|#/),f.tag=h.shift()||"div";if(h.length){f.attr=a.attr||{};var j="",k=/\.([^\.$#]*)/g;while(g=k.exec(i))j+=g[1]+" ";j&&(f.attr["class"]=j.slice(0,j.length-1));var l=/#([^\.$]*)/.exec(i);l&&(f.attr.id=l[1])}}f.attr=f.attr||a.attr,f.innerHTML=f.innerHTML||a.innerHTML;var m=document.createElement(f.tag);a.as=a.as||a.label;if(f.attr)for(var n in f.attr)m.setAttribute(n,f.attr[n]);a.as&&(d[a.as]=m),!a.as&&d&&f.attr&&typeof f.attr["class"]=="string"&&(e&&(g=f.attr["class"].split(" ")[0])||!d[g=f.attr["class"].split(" ")[0]])&&(d[g]=m),typeof f.innerHTML!="undefined"&&(m.innerHTML=f.innerHTML);if(b&&b.require&&b.require("DOM/UA")==="ipad"&&a.events){var o=b.require("DOM/handle")(m);for(var p in a.events)o.on(p,a.events[p])}else if(a.events)for(var p in a.events)m["on"+p]=a.events[p];if(a.style)if(typeof a.style=="string")m.setAttribute("style",a.style);else for(var q in a.style)m.style[q]=a.style[q];if(a.children)for(var r=-1,s=a.children.length;++r<s;)(g=c(a.children[r],d,e))&&m.appendChild(g);return m};return c})
